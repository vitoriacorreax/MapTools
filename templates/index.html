<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
    <title>Mapa da Ferragem</title>
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: #f5f5f5;
        color: #333;
        padding: 8px;
        font-size: 14px;
        line-height: 1.4;
      }
      .topbar {
        background: linear-gradient(135deg, #1f2937, #111827);
        color: #facc15;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 12px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .topbar-header {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .logo {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid #facc15;
        background: #111;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        color: #facc15;
        flex-shrink: 0;
      }
      .logo img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
      }
      .topbar-title {
        flex: 1;
        font-weight: 800;
        letter-spacing: 0.4px;
      }
      .topbar-subtitle {
        font-size: 11px;
        color: #fde68a;
        margin-top: 2px;
      }
      .search-form {
        display: flex;
        gap: 8px;
        width: 100%;
      }
      .search-form input {
        flex: 1;
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #eab308;
        background: #fff;
        color: #111;
        font-size: 14px;
      }
      .search-form button, .search-form a {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid #eab308;
        background: #facc15;
        color: #111;
        text-decoration: none;
        font-weight: 600;
        white-space: nowrap;
        font-size: 12px;
      }
      .search-form a.secondary {
        background: transparent;
        color: #fde68a;
        border-color: #eab308;
      }
      .chips {
        padding: 8px 12px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 12px;
        overflow-x: auto;
      }
      .chip {
        padding: 6px 12px;
        border: 1px solid #ddd;
        border-radius: 20px;
        text-decoration: none;
        color: #333;
        background: #fff;
        white-space: nowrap;
        font-size: 13px;
      }
      .chip.active {
        background: #eef;
        border-color: #0ea5e9;
      }
      #layout {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .panel {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
      }
      .map-container {
        width: 100%;
        overflow-x: auto;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        max-height: calc(100vh - 300px);
      }
      .map-svg {
        width: 100%;
        height: auto;
        min-width: 100%;
        max-width: 100%;
        background: #f8fafc;
        border-radius: 8px;
        display: block;
      }
      .results-panel h2 {
        margin: 0 0 12px 0;
        font-size: 16px;
        font-weight: 700;
      }
      .result-item {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .result-item strong {
        font-size: 15px;
        color: #111;
      }
      .result-item small {
        color: #666;
        font-size: 12px;
      }
      .result-item a {
        display: inline-block;
        padding: 6px 12px;
        border: 1px solid #aaa;
        border-radius: 6px;
        text-decoration: none;
        color: #333;
        font-size: 12px;
        margin-top: 4px;
        align-self: flex-start;
      }
      .map-title {
        font-weight: 700;
        margin-bottom: 8px;
        font-size: 16px;
      }
      .map-info {
        padding: 8px;
        background: #f0f9ff;
        border-radius: 6px;
        font-size: 11px;
        margin-bottom: 12px;
        color: #555;
      }
      @media (max-width: 767px) {
        .map-container {
          max-height: calc(100vh - 250px);
          overflow-x: auto;
          overflow-y: auto;
        }
        .map-svg {
          min-width: 100%;
          max-width: 100%;
        }
        .panel {
          padding: 8px;
        }
        .results-panel {
          max-height: 300px;
          overflow-y: auto;
        }
      }
      @media (min-width: 768px) {
        body {
          padding: 16px;
          max-width: 1400px;
          margin: 0 auto;
        }
        #layout {
          grid-template-columns: 1fr 320px;
        }
        .topbar {
          flex-direction: row;
          align-items: center;
        }
        .search-form {
          width: auto;
          max-width: 600px;
        }
      }
    </style>
  </head>
  <body>
    <div class="topbar">
      <div class="topbar-header">
        {% if logo_url %}
          <div class="logo">
            <img src="{{ logo_url }}" alt="Logo" />
          </div>
        {% else %}
          <div class="logo">FF</div>
        {% endif %}
        <div class="topbar-title">
          <div>Ferragem F√™nix</div>
          <div class="topbar-subtitle">Aberta todos os dias ‚Ä¢ Sempre aberta ao meio‚Äëdia</div>
        </div>
      </div>
      <form method="get" action="/" class="search-form">
        <input name="q" value="{{ query }}" placeholder="Buscar produtos..." />
        <button type="submit">Buscar</button>
        <a href="/" class="secondary">Limpar</a>
      </form>
    </div>


    <div id="layout">
      <section class="panel" id="map-top">
        <div class="map-title">Mapa da Loja</div>
        <div class="map-info">
          <strong>üìç Orienta√ß√£o:</strong> √Åreas cinza = <strong>ESTOQUE/BALC√ÉO/ENTRADA</strong> | N√∫meros coloridos = <strong>SE√á√ïES</strong> | Clique para ver produtos
        </div>

        {% if view_mode=='map' %}
        <div class="map-container">
          <svg viewBox="0 0 {{ svg_width }} {{ svg_height }}" class="map-svg" xmlns="http://www.w3.org/2000/svg">
            <!-- PAREDES PRETAS (BORDAS GROSSAS) -->
            <!-- Parede superior -->
            <rect x="0" y="0" width="{{ svg_width }}" height="{{ walls_cfg.thickness }}" fill="{{ walls_cfg.color }}" />
            <!-- Parede inferior -->
            <rect x="0" y="{{ svg_height - walls_cfg.thickness }}" width="{{ svg_width }}" height="{{ walls_cfg.thickness }}" fill="{{ walls_cfg.color }}" />
            <!-- Parede esquerda -->
            <rect x="0" y="0" width="{{ walls_cfg.thickness }}" height="{{ svg_height }}" fill="{{ walls_cfg.color }}" />
            <!-- Parede direita -->
            <rect x="{{ svg_width - walls_cfg.thickness }}" y="0" width="{{ walls_cfg.thickness }}" height="{{ svg_height }}" fill="{{ walls_cfg.color }}" />
            
            <!-- √ÅREAS FUNCIONAIS (CINZA) - ESTOQUE, BALC√ÉO, ENTRADA E PAREDES -->
            {% for z in svg_functional %}
            <rect 
              x="{{ z.x }}" 
              y="{{ z.y }}" 
              width="{{ z.w }}" 
              height="{{ z.h }}" 
              fill="{{ z.fill }}" 
              stroke="{% if z.type == 'wall' %}{{ z.fill }}{% else %}#9ca3af{% endif %}" 
              stroke-width="{% if z.type == 'wall' %}0{% else %}1{% endif %}"
            />
            {% if z.label %}
            <text 
              x="{{ z.x + z.w/2 }}" 
              y="{{ z.y + z.h/2 }}" 
              text-anchor="middle" 
              dominant-baseline="middle" 
              font-size="{{ z.fs }}" 
              font-weight="bold" 
              fill="#374151"
            >{{ z.label }}</text>
            {% endif %}
            {% endfor %}
            
            <!-- SE√á√ïES NUMERADAS (COLORIDAS E CLIC√ÅVEIS) -->
            {% for z in svg_sections %}
            {% set is_sel = (selected_col is not none and selected_col==z.col) %}
            <a xlink:href="/?q={{ query }}&cat={{ active_category }}&view={{ view_mode }}&cell={{ cell_px }}&col={{ z.col }}" style="cursor: pointer;">
              <rect 
                x="{{ z.x }}" 
                y="{{ z.y }}" 
                width="{{ z.w }}" 
                height="{{ z.h }}" 
                fill="{{ z.fill }}" 
                stroke="{% if is_sel %}#0ea5e9{% else %}#9ca3af{% endif %}" 
                stroke-width="{% if is_sel %}3{% else %}1{% endif %}"
                opacity="0.9"
              />
              <text 
                x="{{ z.x + z.w/2 }}" 
                y="{{ z.y + z.h/2 }}" 
                text-anchor="middle" 
                dominant-baseline="middle" 
                font-size="{{ z.fs }}" 
                font-weight="bold" 
                fill="#fff"
                style="text-shadow: 1px 1px 2px rgba(0,0,0,0.3);"
              >{{ z.label }}</text>
            </a>
            {% endfor %}
            
            <!-- PRODUTOS (PONTOS NO MAPA) -->
            {% for it in svg_items %}
            <circle 
              cx="{{ it.cx }}" 
              cy="{{ it.cy }}" 
              r="{{ it.r }}" 
              fill="{{ it.fill }}" 
              stroke="#fff" 
              stroke-width="2"
              style="pointer-events: none;"
            />
            {% endfor %}
          </svg>
        </div>
        {% else %}
        <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;">
          {% for it in items %}
          <li class="result-item">
            <div>
              <strong>{{ it.name }}</strong>
              <div style="margin-top:4px;"><small>SKU {{ it.sku }} ‚Ä¢ {{ it.category }}</small></div>
              <div><small>Se√ß√£o: <strong>{{ it.aisle_display }}</strong></small></div>
            </div>
            <a href="/?q={{ query }}&cat={{ active_category }}&view={{ view_mode }}&cell={{ cell_px }}&col={{ it.x }}#map-top">Ir no mapa</a>
          </li>
          {% endfor %}
        </ul>
        {% endif %}
      </section>

      <aside class="panel results-panel">
        <h2>Resultados ({{ items|length }})</h2>
        {% if items|length == 0 %}
          <p style="color: #666;">Nenhum item encontrado.</p>
        {% else %}
          <div>
            {% for it in items %}
            <div class="result-item">
              <div>
                <strong>{{ it.name }}</strong>
                <div style="margin-top:4px;"><small>SKU {{ it.sku }} ‚Ä¢ {{ it.category }}</small></div>
                <div><small>Se√ß√£o: <strong>{{ it.aisle_display }}</strong></small></div>
              </div>
              <a href="/?q={{ query }}&cat={{ active_category }}&view={{ view_mode }}&cell={{ cell_px }}&col={{ it.x }}#map-top">Ir no mapa</a>
            </div>
            {% endfor %}
          </div>
        {% endif %}
      </aside>
    </div>

    <div style="padding:12px 16px;text-align:center;color:#666;font-size:12px;margin-top:16px;">
      <small>Mapa Virtual Interativo - Ferragem F√™nix</small>
    </div>
  </body>
</html>
