<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mapa do Estoque - Ferragem</title>
    <style>
      /* CSS interno para responsividade */
      #layout { display:grid; grid-template-columns: 1fr 360px; gap:16px; padding:16px; }
      .panel { border:1px solid #ddd; border-radius:8px; padding:12px; background:#fff; }
      .result-item { display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center; }
      .chips { padding:12px 16px; display:flex; flex-wrap:wrap; gap:8px; }
      .topbar { padding:16px; border-bottom:1px solid #eab308; display:flex; gap:12px; align-items:center; justify-content:space-between; background:linear-gradient(135deg,#111827,#1f2937); color:#facc15; }
      h2 { margin:4px 0 12px; font-size:18px; }
      body { font-size:16px; line-height:1.35; }
      @media (max-width: 768px) {
        #layout { grid-template-columns: 1fr; padding:8px; gap:12px; }
        .panel { padding:10px; border-radius:10px; }
        .result-item { grid-template-columns: 1fr; }
        .chips { gap:6px; padding:8px; overflow-x:auto; white-space:nowrap; }
        .chips a { display:inline-block; }
        .topbar { flex-direction: column; align-items: stretch; }
        .topbar form { width:100%; display:flex; gap:8px; }
        .topbar form input { width:100%; flex:1; }
        .topbar form input, .topbar form button, .topbar form a { font-size:16px; padding:10px 12px !important; }
        svg { max-height: 360px; }
      }
    </style>
  </head>
  <body>
    <div class="topbar">
        <div style="display:flex;align-items:center;gap:12px;">
          {% if logo_url %}
            <img src="{{ logo_url }}" alt="Ferragem F√™nix" style="width:44px;height:44px;border-radius:9999px;object-fit:cover;border:2px solid #facc15;background:#111;" />
          {% else %}
            <div style="width:44px;height:44px;border-radius:9999px;background:#facc15;color:#111;display:flex;align-items:center;justify-content:center;font-weight:800;">FF</div>
          {% endif %}
        <div>
          <div style="font-weight:800;letter-spacing:.4px;">Ferragem F√™nix</div>
          <div style="font-size:12px;color:#fde68a;">Aberta todos os dias ‚Ä¢ Sempre aberta ao meio‚Äëdia</div>
        </div>
      </div>
           <form method="get" action="/" style="display:flex;gap:8px;">
             <input name="q" value="{{ query }}" placeholder="Buscar produtos..." style="padding:8px;border-radius:8px;border:1px solid #eab308;color:#111;" />
             <button type="submit" style="padding:8px 12px;border-radius:8px;background:#facc15;color:#111;border:1px solid #eab308;">Buscar</button>
             <a href="/" style="padding:8px 12px;border:1px solid #eab308;border-radius:8px;text-decoration:none;color:#fde68a;">Limpar</a>
             <a href="/admin" style="padding:8px 12px;border:1px solid #8b5cf6;border-radius:8px;text-decoration:none;color:#8b5cf6;background:#f3f4f6;">üé® Editar Mapa</a>
           </form>
    </div>

    <div id="chips" class="chips">
      <a href="/?q={{ query }}" style="padding:6px 10px;border:1px solid #ddd;border-radius:20px;text-decoration:none;{% if not active_category %}background:#eef;{% endif %}">Todas</a>
      {% for cat in categories %}
      <a href="/?q={{ query }}&cat={{ cat }}&view={{ view_mode }}&cell={{ cell_px }}" style="padding:6px 10px;border:1px solid #ddd;border-radius:20px;text-decoration:none;{% if active_category==cat %}background:#eef;{% endif %}">{{ cat }}</a>
      {% endfor %}
    </div>

    <div id="layout">
      <section class="panel" id="map-top">
        <div style="margin-bottom:12px;font-weight:700;">Mapa da Loja</div>
        <div style="margin-bottom:8px;padding:8px;background:#f0f9ff;border-radius:6px;font-size:12px;">
          <strong>üìç Orienta√ß√£o:</strong> Linha verde = <strong>ENTRADA</strong> | Cores = <strong>PRATELEIRAS</strong> | <strong>üìä Coordenadas:</strong> X=coluna, Y=linha (ex: X=5, Y=3)
      </div>

        {% if view_mode=='map' %}
          <h2 style="margin:4px 0 12px;">Mapa ({{ map_cfg.width }} √ó {{ map_cfg.height }})</h2>
          <svg viewBox="0 0 {{ svg_width }} {{ svg_height }}" width="100%" xmlns="http://www.w3.org/2000/svg" style="border:1px solid #ddd;border-radius:8px;background:#f8fafc;">
            <defs>
              <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                <feDropShadow dx="0" dy="1" stdDeviation="2" flood-color="#00000055" />
              </filter>
            </defs>
            
            <!-- PAREDES DA LOJA -->
            <!-- Parede superior -->
            <line x1="0" y1="0" x2="{{ svg_width }}" y2="0" stroke="#374151" stroke-width="3" />
            <!-- Parede esquerda -->
            <line x1="0" y1="0" x2="0" y2="{{ svg_height }}" stroke="#374151" stroke-width="3" />
            <!-- Parede direita -->
            <line x1="{{ svg_width }}" y1="0" x2="{{ svg_width }}" y2="{{ svg_height }}" stroke="#374151" stroke-width="3" />
            <!-- Parede inferior (com abertura da porta) -->
            <line x1="0" y1="{{ svg_height }}" x2="{{ svg_width * 0.7 }}" y2="{{ svg_height }}" stroke="#374151" stroke-width="3" />
            <line x1="{{ svg_width * 0.8 }}" y1="{{ svg_height }}" x2="{{ svg_width }}" y2="{{ svg_height }}" stroke="#374151" stroke-width="3" />
            
            <!-- SISTEMA DE COORDENADAS X,Y -->
            <!-- Grid de coordenadas no fundo -->
            {% set cell_width = svg_width / map_width %}
            {% set cell_height = svg_height / map_height %}
            
            <!-- Linhas verticais (X) -->
            {% for x in range(map_width + 1) %}
            <line x1="{{ x * cell_width }}" y1="0" x2="{{ x * cell_width }}" y2="{{ svg_height }}" stroke="#e5e7eb" stroke-width="1" opacity="0.5" />
            {% endfor %}
            
            <!-- Linhas horizontais (Y) -->
            {% for y in range(map_height + 1) %}
            <line x1="0" y1="{{ y * cell_height }}" x2="{{ svg_width }}" y2="{{ y * cell_height }}" stroke="#e5e7eb" stroke-width="1" opacity="0.5" />
            {% endfor %}
            
            <!-- N√∫meros das coordenadas X (colunas) -->
            {% for x in range(map_width) %}
            <text x="{{ (x + 0.5) * cell_width }}" y="15" text-anchor="middle" font-size="10" fill="#6b7280" font-weight="bold">{{ x }}</text>
            {% endfor %}
            
            <!-- N√∫meros das coordenadas Y (linhas) -->
            {% for y in range(map_height) %}
            <text x="10" y="{{ (y + 0.5) * cell_height + 3 }}" text-anchor="middle" font-size="10" fill="#6b7280" font-weight="bold">{{ y }}</text>
            {% endfor %}
            
            <!-- DIVIS√ìRIAS INTERNAS -->
            <!-- Divis√≥ria entre estoque e balc√£o -->
            <line x1="{{ svg_width * 0.3 }}" y1="0" x2="{{ svg_width * 0.3 }}" y2="{{ svg_height * 0.2 }}" stroke="#6b7280" stroke-width="2" stroke-dasharray="5,5" />
            <!-- Divis√≥ria entre balc√£o e √°rea de vendas -->
            <line x1="{{ svg_width * 0.6 }}" y1="0" x2="{{ svg_width * 0.6 }}" y2="{{ svg_height * 0.2 }}" stroke="#6b7280" stroke-width="2" stroke-dasharray="5,5" />
            
            <!-- √ÅREAS FUNCIONAIS -->
            <!-- As √°reas funcionais s√£o renderizadas dinamicamente pelas zonas do inventory.json -->
            
            <!-- PRATELEIRAS COLORIDAS (CLIC√ÅVEIS) -->
            {% for z in svg_zones %}
            {% if z.label != "ENTRADA" %}
            {% set is_sel = (selected_col is not none and selected_col==z.col) %}
            <a xlink:href="/?q={{ query }}&cat={{ active_category }}&view={{ view_mode }}&cell={{ cell_px }}&col={{ z.col }}">
              <rect x="{{ z.x }}" y="{{ z.y }}" width="{{ z.w }}" height="{{ z.h }}" fill="{{ z.fill }}" stroke="{% if is_sel %}#0ea5e9{% else %}#9ca3af{% endif %}" stroke-width="{% if is_sel %}3{% else %}1{% endif %}" />
              <text x="{{ z.x + z.w/2 }}" y="{{ z.y + z.h/2 }}" text-anchor="middle" font-size="10" fill="#374151" font-weight="bold">{{ z.label }}</text>
            </a>
            {% endif %}
            {% endfor %}
            
            <!-- PORTA (linha verde no canto inferior direito) -->
            <line x1="{{ svg_width * 0.7 }}" y1="{{ svg_height }}" x2="{{ svg_width * 0.8 }}" y2="{{ svg_height }}" stroke="#22c55e" stroke-width="8" />
            <text x="{{ svg_width * 0.75 }}" y="{{ svg_height - 5 }}" text-anchor="middle" font-size="10" fill="#22c55e" font-weight="bold">ENTRADA</text>

            <!-- PONTOS DOS PRODUTOS -->
            {% for it in svg_items %}
            <a id="pos-{{ it.gx }}-{{ it.gy }}" href="#pos-{{ it.gx }}-{{ it.gy }}">
              <circle cx="{{ it.cx }}" cy="{{ it.cy }}" r="{{ it.r }}" fill="{{ it.fill }}" stroke="#fff" stroke-width="1" />
            </a>
            {% endfor %}
          </svg>
        {% else %}
          <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;">
            {% for it in items %}
            <li style="border:1px solid #ddd;border-radius:8px;padding:8px 10px;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;">
              <div>
                <div><strong>{{ it.name }}</strong></div>
                <div style="font-size:12px;color:#555;">SKU {{ it.sku }} ‚Ä¢ {{ it.category }}</div>
                <div style="font-size:12px;color:#555;">Corredor: <strong>{{ it.aisle_display }}</strong></div>
              </div>
              <div style="text-align:right;">
                <a href="/?q={{ query }}&cat={{ active_category }}&view={{ view_mode }}&cell={{ cell_px }}&col={{ it.x }}#map-top" style="display:inline-block;margin-top:6px;padding:6px 10px;border:1px solid #aaa;border-radius:6px;text-decoration:none;color:inherit;">Ir no mapa</a>
              </div>
            </li>
            {% endfor %}
          </ul>
        {% endif %}
      </section>

      <aside class="panel">
        <h2 style="margin:4px 0 12px;">Resultados</h2>
        {% if items|length == 0 %}
          <p>Nenhum item encontrado.</p>
        {% else %}
          <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;">
            {% for it in items %}
            <li class="result-item" style="border:1px solid #ddd;border-radius:8px;padding:8px 10px;">
              <div>
                <div><strong>{{ it.name }}</strong></div>
                <div style="font-size:12px;color:#555;">SKU {{ it.sku }} ‚Ä¢ {{ it.category }}</div>
                <div style="font-size:12px;color:#555;">Corredor: <strong>{{ it.aisle_display }}</strong></div>
              </div>
              <div>
                <a href="/?q={{ query }}&cat={{ active_category }}&view={{ view_mode }}&cell={{ cell_px }}&col={{ it.x }}#map-top" style="display:inline-block;margin-top:6px;padding:6px 10px;border:1px solid #aaa;border-radius:6px;text-decoration:none;color:inherit;">Ir no mapa</a>
              </div>
            </li>
            {% endfor %}
          </ul>
        {% endif %}
      </aside>
    </div>

    <div style="padding:12px 16px;border-top:1px solid #ddd;color:#666;">
      <small>Exemplo educacional - Universidade</small>
    </div>
  </body>
  </html>


